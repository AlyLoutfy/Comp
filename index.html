<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Excel Comparison Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      .container {
        max-width: 1400px;
        height: 100vh;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin: 20px auto;
        height: calc(100vh - 40px);
      }

      .header {
        background: linear-gradient(135deg, #1d1d1f 0%, #2c2c2e 100%);
        color: white;
        padding: 14px 20px;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        flex-shrink: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header > div:first-child {
        grid-column: 2;
        text-align: center;
      }

      .header-actions {
        grid-column: 3;
        justify-self: end;
      }

      .header .howitworks {
        margin-bottom: 0;
      }

      .header h1 {
        font-size: 1.6em;
        margin: 0 0 4px 0;
        font-weight: 600;
        letter-spacing: -0.5px;
      }

      .header p {
        font-size: 0.95em;
        opacity: 0.8;
        margin: 0;
        font-weight: 400;
      }

      .main-content {
        flex: 1;
        display: flex;
        overflow: hidden;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .upload-panel {
        width: 400px;
        background: rgba(248, 249, 250, 0.8);
        border-right: 1px solid rgba(0, 0, 0, 0.06);
        padding: 32px;
        display: flex;
        flex-direction: column;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        position: relative;
      }

      .upload-panel.compressed {
        width: 300px;
        padding: 24px;
      }

      .results-panel {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.6);
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .results-panel.expanded {
        padding: 24px;
      }

      .upload-section {
        margin-bottom: 24px;
        flex-shrink: 0;
      }

      .file-input-group {
        margin-bottom: 20px;
        padding: 20px;
        border: 2px dashed rgba(0, 122, 255, 0.3);
        border-radius: 16px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
      }

      .file-input-group:hover {
        border-color: rgba(0, 122, 255, 0.6);
        background: rgba(0, 122, 255, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 122, 255, 0.15);
      }

      .file-input-group.has-file {
        border-color: #34c759;
        background: rgba(52, 199, 89, 0.05);
      }

      .file-input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 12px;
        color: #1d1d1f;
        font-size: 1.1em;
        letter-spacing: -0.2px;
      }

      .file-input-group input[type="file"] {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        font-size: 0.95em;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
      }

      .file-input-group input[type="file"]:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
      }

      .file-info {
        margin-top: 12px;
        padding: 12px 16px;
        background: rgba(0, 122, 255, 0.08);
        border-radius: 12px;
        font-size: 0.85em;
        color: #1d1d1f;
        border-left: 3px solid #007aff;
      }

      .compare-btn {
        width: 100%;
        padding: 18px 28px;
        background: linear-gradient(135deg, #1d1d1f 0%, #2c2c2e 100%);
        color: white;
        border: 2px solid transparent;
        border-radius: 20px;
        font-size: 1.1em;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-top: 24px;
        flex-shrink: 0;
        letter-spacing: -0.3px;
        box-shadow: 0 8px 25px rgba(29, 29, 31, 0.25);
        position: relative;
        overflow: hidden;
      }

      .compare-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.6s;
      }

      .compare-btn:hover::before {
        left: 100%;
      }

      .compare-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(29, 29, 31, 0.35);
        border-color: rgba(0, 122, 255, 0.3);
      }

      .compare-btn:active {
        transform: translateY(0);
        box-shadow: 0 6px 20px rgba(29, 29, 31, 0.25);
      }

      .compare-btn:disabled {
        background: linear-gradient(135deg, #8e8e93 0%, #aeaeb2 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 4px 12px rgba(142, 142, 147, 0.2);
        border-color: transparent;
      }

      .loading {
        display: none;
        text-align: center;
        margin: 24px 0;
        flex-shrink: 0;
      }

      .spinner {
        border: 3px solid rgba(0, 122, 255, 0.1);
        border-top: 3px solid #007aff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .results {
        display: none;
        margin-top: 0;
        padding: 0;
        background: transparent;
        border-radius: 0;
        flex: 1;
        overflow-y: auto;
      }

      .results h3 {
        color: #1d1d1f;
        margin-bottom: 20px;
        font-size: 1.4em;
        font-weight: 600;
        letter-spacing: -0.3px;
      }

      /* Simple accordion */
      .accordion-section {
        margin: 8px 0 6px 0;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: rgba(255, 255, 255, 0.6);
      }

      .accordion-toggle {
        width: 100%;
        text-align: left;
        padding: 10px 12px;
        background: transparent;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: #1d1d1f;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.95em;
      }

      .accordion-content {
        display: none;
        padding: 8px 12px 12px 12px;
        max-height: 160px;
        overflow: auto;
      }

      .accordion-section.open .accordion-content {
        display: block;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        background: rgba(0, 122, 255, 0.08);
        border: 1px solid rgba(0, 122, 255, 0.18);
        color: #1d1d1f;
        padding: 4px 8px;
        border-radius: 8px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }

      /* Tabs UI for results */
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        padding-bottom: 8px;
      }

      .tab-btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        font-weight: 600;
        color: #1d1d1f;
      }

      .tab-btn.active {
        background: rgba(0, 122, 255, 0.12);
        border-color: rgba(0, 122, 255, 0.25);
      }

      .tab-panel {
        display: none;
        margin-top: 8px;
      }

      .tab-panel.active {
        display: block;
      }

      .id-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 8px;
        max-height: 420px;
        overflow: auto;
      }

      .id-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 10px;
        padding: 6px 8px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }

      .discrepancy-item {
        background: rgba(255, 255, 255, 0.8);
        padding: 12px 16px;
        margin-bottom: 10px;
        border-radius: 16px;
        border-left: 4px solid #ff3b30;
        box-shadow: 0 4px 20px rgba(255, 59, 48, 0.1);
        font-size: 0.9em;
        line-height: 1.25;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .discrepancy-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(255, 59, 48, 0.15);
      }

      .discrepancy-item strong {
        color: #ff3b30;
        font-weight: 600;
      }

      .discrepancy-item small {
        display: block;
        margin-top: 4px;
        font-size: 0.82em;
        opacity: 0.9;
      }

      /* Copy icon next to Unit ID */
      .copy-btn {
        margin-left: 8px;
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        background: rgba(0, 122, 255, 0.12);
        color: #1d1d1f;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        line-height: 1;
        transition: all 0.2s ease;
      }

      .copy-btn:hover {
        background: rgba(0, 122, 255, 0.2);
        transform: translateY(-1px);
      }

      .copy-btn.copied {
        background: rgba(52, 199, 89, 0.8) !important;
        color: white !important;
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.4);
      }

      .copy-btn.copied::after {
        content: " ✓";
        font-weight: bold;
      }

      /* Copy status text */
      .copy-status {
        color: #34c759;
        font-size: 11px;
        font-weight: 600;
        margin-left: 4px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .copy-status.show {
        opacity: 1;
      }

      /* Status labels */
      .status-labels {
        display: flex;
        gap: 8px;
        margin-left: auto;
        align-items: center;
      }

      .status-label {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-available {
        background: rgba(52, 199, 89, 0.15);
        color: #34c759;
        border: 1px solid rgba(52, 199, 89, 0.3);
      }

      .status-blocked {
        background: rgba(255, 59, 48, 0.15);
        color: #ff3b30;
        border: 1px solid rgba(255, 59, 48, 0.3);
      }

      .status-unavailable {
        background: rgba(142, 142, 147, 0.15);
        color: #8e8e93;
        border: 1px solid rgba(142, 142, 147, 0.3);
      }

      .status-price {
        background: rgba(255, 193, 7, 0.15);
        color: #ff9800;
        border: 1px solid rgba(255, 193, 7, 0.3);
      }

      .discrepancy-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .download-btn {
        display: inline-block;
        padding: 12px 24px;
        background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-weight: 600;
        margin-top: 16px;
        transition: all 0.3s ease;
        font-size: 0.95em;
        letter-spacing: -0.1px;
        box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(52, 199, 89, 0.4);
      }

      .export-section {
        margin-top: 32px;
        padding: 24px;
        background: rgba(0, 122, 255, 0.05);
        border-radius: 20px;
        border: 1px solid rgba(0, 122, 255, 0.1);
        backdrop-filter: blur(10px);
      }

      .export-section h4 {
        color: #1d1d1f;
        margin-bottom: 20px;
        font-size: 1.2em;
        font-weight: 600;
        letter-spacing: -0.2px;
      }

      .export-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .export-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 14px 20px;
        background: rgba(255, 255, 255, 0.9);
        color: #1d1d1f;
        text-decoration: none;
        border-radius: 16px;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.9em;
        border: 2px solid rgba(0, 0, 0, 0.08);
        cursor: pointer;
        letter-spacing: -0.1px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .export-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.05), transparent);
        transition: left 0.5s;
      }

      .export-btn:hover::before {
        left: 100%;
      }

      .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        border-color: rgba(0, 0, 0, 0.15);
      }

      .export-btn.csv {
        background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(48, 209, 88, 0.1) 100%);
        border-color: rgba(52, 199, 89, 0.2);
        color: #34c759;
      }

      .export-btn.csv:hover {
        background: linear-gradient(135deg, rgba(52, 199, 89, 0.15) 0%, rgba(48, 209, 88, 0.15) 100%);
        border-color: rgba(52, 199, 89, 0.3);
      }

      .export-btn.excel {
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.1) 0%, rgba(88, 86, 214, 0.1) 100%);
        border-color: rgba(0, 122, 255, 0.2);
        color: #007aff;
      }

      .export-btn.excel:hover {
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.15) 0%, rgba(88, 86, 214, 0.15) 100%);
        border-color: rgba(0, 122, 255, 0.3);
      }

      .export-btn.json {
        background: linear-gradient(135deg, rgba(175, 82, 222, 0.1) 0%, rgba(191, 90, 242, 0.1) 100%);
        border-color: rgba(175, 82, 222, 0.2);
        color: #af52de;
      }

      .export-btn.json:hover {
        background: linear-gradient(135deg, rgba(175, 82, 222, 0.15) 0%, rgba(191, 90, 242, 0.15) 100%);
        border-color: rgba(175, 82, 222, 0.3);
      }

      .copy-all-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 18px;
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
        color: #ff9800;
        border: 2px solid rgba(255, 193, 7, 0.2);
        border-radius: 14px;
        font-weight: 600;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .copy-all-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 193, 7, 0.1), transparent);
        transition: left 0.5s;
      }

      .copy-all-btn:hover::before {
        left: 100%;
      }

      .copy-all-btn:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.15) 100%);
        border-color: rgba(255, 193, 7, 0.3);
        box-shadow: 0 8px 20px rgba(255, 193, 7, 0.2);
      }

      .copy-all-btn:active {
        transform: translateY(0);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);
      }

      .error {
        background: rgba(255, 59, 48, 0.1);
        color: #ff3b30;
        padding: 20px 24px;
        border-radius: 16px;
        margin-top: 16px;
        border: 1px solid rgba(255, 59, 48, 0.2);
        font-size: 0.95em;
        backdrop-filter: blur(10px);
      }

      .success {
        background: rgba(52, 199, 89, 0.1);
        color: #34c759;
        padding: 20px 24px;
        border-radius: 16px;
        margin-top: 16px;
        border: 1px solid rgba(52, 199, 89, 0.2);
        font-size: 0.95em;
        backdrop-filter: blur(10px);
      }

      .stats {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .stat {
        background: rgba(0, 122, 255, 0.06);
        border: 1px solid rgba(0, 122, 255, 0.12);
        color: #1d1d1f;
        padding: 8px 12px;
        border-radius: 12px;
        font-weight: 600;
      }

      /* Beautiful unified summary card */
      .summary-card {
        position: sticky;
        top: 8px;
        background: linear-gradient(135deg, rgba(52, 199, 89, 0.12) 0%, rgba(0, 122, 255, 0.08) 100%);
        border: 1px solid rgba(52, 199, 89, 0.2);
        border-radius: 20px;
        padding: 20px 24px;
        margin-bottom: 16px;
        box-shadow: 0 8px 32px rgba(52, 199, 89, 0.15);
        backdrop-filter: blur(20px);
        z-index: 10;
      }

      .summary-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }

      .summary-title {
        font-size: 1.4em;
        font-weight: 700;
        color: #1d1d1f;
        margin: 0;
      }

      .summary-subtitle {
        color: #34c759;
        font-weight: 600;
        font-size: 1em;
        margin: 4px 0 0 0;
      }

      .summary-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .summary-stats {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .summary-stat {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 122, 255, 0.15);
        color: #1d1d1f;
        padding: 10px 14px;
        border-radius: 14px;
        font-weight: 600;
        font-size: 0.95em;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.1);
        backdrop-filter: blur(10px);
      }

      .instructions {
        background: rgba(0, 122, 255, 0.05);
        padding: 20px 24px;
        border-radius: 16px;
        margin-bottom: 24px;
        border: 1px solid rgba(0, 122, 255, 0.1);
        flex-shrink: 0;
        backdrop-filter: blur(10px);
      }

      /* Header actions */
      .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .header .tooltip-button {
        background: #000;
        color: #fff;
      }

      /* Primary small button (header actions) */
      .btn-sm {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-sm:hover {
        background: rgba(255, 255, 255, 0.12);
        transform: translateY(-1px);
      }

      /* Tooltip styles for How it works */
      .howitworks {
        position: relative;
        align-self: flex-start;
        margin-bottom: 16px;
      }

      .tooltip-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
        color: #fff;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
      }

      .tooltip-content {
        display: none;
      }

      .howitworks:hover .tooltip-content,
      .howitworks.open .tooltip-content {
        display: block;
      }

      .instructions h3 {
        color: #1d1d1f;
        margin-bottom: 16px;
        font-size: 1.1em;
        font-weight: 600;
        letter-spacing: -0.2px;
      }

      .instructions ul {
        margin-left: 0;
        margin-bottom: 0;
        list-style: none;
      }

      .instructions li {
        margin-bottom: 8px;
        color: #1d1d1f;
        font-size: 0.9em;
        position: relative;
        padding-left: 20px;
      }

      .instructions li:before {
        content: "•";
        color: #007aff;
        font-weight: bold;
        position: absolute;
        left: 0;
      }

      /* Responsive design for smaller screens */
      @media (max-width: 768px) {
        .container {
          margin: 10px;
          height: calc(100vh - 20px);
        }

        .header {
          display: flex;
          flex-direction: column;
          text-align: center;
          gap: 4px;
        }

        .header {
          padding: 10px 14px;
        }

        .header h1 {
          font-size: 1.3em;
          margin-bottom: 2px;
        }

        .header p {
          font-size: 0.85em;
        }

        .main-content {
          flex-direction: column;
        }

        .upload-panel {
          width: 100%;
          padding: 16px;
        }

        .upload-panel.compressed {
          width: 100%;
          padding: 16px;
        }

        .results-panel {
          padding: 16px;
        }

        .results-panel.expanded {
          padding: 16px;
        }

        .summary-card {
          position: static;
          margin-bottom: 12px;
        }

        .summary-title {
          font-size: 1.1em;
        }

        .summary-subtitle {
          font-size: 0.9em;
        }

        .summary-actions {
          gap: 6px;
        }

        .export-btn,
        .compare-btn {
          padding: 10px 14px;
          font-size: 0.9em;
        }

        .id-grid {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
          gap: 6px;
        }

        .discrepancy-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .status-labels {
          width: 100%;
          justify-content: flex-start;
          flex-wrap: wrap;
          gap: 6px;
        }

        .status-label {
          font-size: 10px;
          padding: 3px 6px;
        }
      }

      /* Drag & drop upload cards */
      .file-input-group.droppable {
        border-style: solid;
        border-color: rgba(0, 122, 255, 0.35);
        background: rgba(0, 122, 255, 0.06);
      }

      .file-input-group .helper {
        margin-top: 10px;
        font-size: 0.85em;
        color: #3a3a3c;
        opacity: 0.9;
      }

      /* Fullscreen Help modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(6px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-overlay.show {
        display: flex;
      }

      .modal-dialog {
        width: min(820px, calc(100vw - 40px));
        max-height: calc(100vh - 80px);
        overflow: auto;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(245, 247, 250, 0.98));
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 20px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.25);
        padding: 22px 22px 18px 22px;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .modal-title {
        font-size: 1.4em;
        font-weight: 700;
        color: #1d1d1f;
        margin: 0;
      }

      .modal-close {
        border: none;
        background: rgba(0, 0, 0, 0.06);
        color: #1d1d1f;
        border-radius: 10px;
        width: 32px;
        height: 32px;
        cursor: pointer;
        font-weight: 700;
      }

      .modal-section {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 14px;
        padding: 14px 16px;
        margin-top: 10px;
      }

      /* Results toolbar */
      .results-toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        position: sticky;
        top: 0;
        z-index: 5;
      }

      .search-input {
        flex: 1;
        min-width: 220px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.12);
        background: rgba(255, 255, 255, 0.9);
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(6px);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 1100;
      }

      .loading-overlay.show {
        display: flex;
      }

      .progress {
        width: 260px;
        height: 8px;
        background: rgba(0, 0, 0, 0.08);
        border-radius: 999px;
        overflow: hidden;
        margin-top: 12px;
      }

      .progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #007aff, #5856d6);
        transition: width 0.2s ease;
      }

      /* Mid-size screens: place upload inputs side-by-side to reduce height */
      @media (min-width: 900px) and (max-width: 1280px) {
        .upload-section {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 16px;
        }
      }

      @media (max-height: 600px) {
        .header {
          padding: 16px 24px;
        }
        .header h1 {
          font-size: 1.8em;
        }
        .header p {
          font-size: 1em;
        }
        .upload-panel {
          padding: 20px;
        }
        .results-panel {
          padding: 20px;
        }
        .instructions {
          padding: 16px 20px;
          margin-bottom: 16px;
        }
        .file-input-group {
          padding: 16px;
          margin-bottom: 16px;
        }
        .compare-btn {
          padding: 12px 20px;
          margin-top: 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <h1>Excel Comparison Tool</h1>
          <p>Compare Modon and Sakneen Excel sheets for status discrepancies</p>
        </div>
        <div class="header-actions">
          <button type="button" class="btn-sm" id="openHelpBtn" aria-haspopup="dialog" aria-controls="helpModal">Help ⌘/</button>
        </div>
      </div>

      <div class="main-content">
        <div class="upload-panel" id="uploadPanel">
          <form id="uploadForm" enctype="multipart/form-data">
            <div class="upload-section">
              <div class="file-input-group" id="modonGroup">
                <label for="modon_file">Modon Excel File</label>
                <input type="file" id="modon_file" name="modon_file" accept=".xlsx,.xls" required />
                <div class="file-info">Columns: "Unit Number", "EOI", and "8 Yrs EGP Price" (headers at row 3)</div>
              </div>

              <div class="file-input-group" id="sakneenGroup">
                <label for="sakneen_file">Sakneen Excel File</label>
                <input type="file" id="sakneen_file" name="sakneen_file" accept=".xlsx,.xls" required />
                <div class="file-info">Columns: "UnitID", "Status", and "Price" (headers at row 1)</div>
              </div>
            </div>

            <button type="submit" class="compare-btn" id="compareBtn">Compare Files</button>
          </form>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing...</p>
          </div>
        </div>

        <div class="results-panel" id="resultsPanel">
          <div class="results-toolbar" id="resultsToolbar" style="display: none">
            <input type="search" id="searchInput" class="search-input" placeholder="Search unit IDs or text (⌘K)" aria-label="Search results" />
            <div style="display: flex; gap: 8px">
              <button class="export-btn csv" id="exportCsvBtnTop">CSV</button>
              <button class="export-btn excel" id="exportExcelBtnTop">Excel</button>
              <button class="export-btn json" id="exportJsonBtnTop">JSON</button>
            </div>
          </div>
          <div class="results" id="results"></div>
        </div>
      </div>
    </div>

    <!-- Version indicator -->
    <div style="position: fixed; bottom: 8px; right: 8px; font-size: 10px; color: #666; background: rgba(255, 255, 255, 0.8); padding: 2px 6px; border-radius: 4px; z-index: 1000">v1.1.1</div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="modal-dialog">
        <div class="modal-header">
          <h2 class="modal-title" id="helpTitle">How it works</h2>
          <button class="modal-close" id="closeHelpBtn" aria-label="Close">×</button>
        </div>
        <div class="modal-section">
          <h3 style="margin: 0 0 8px 0; font-size: 1.05em">Steps</h3>
          <ul style="margin-left: 16px">
            <li>Upload Modon Excel (headers at row 3) and Sakneen Excel (headers at row 1)</li>
            <li>Compare Unit Number (Modon) with UnitID (Sakneen)</li>
            <li>Unit unavailable in Modon if EOI or Sales Agent has value</li>
            <li>Download the highlighted Sakneen file</li>
          </ul>
        </div>
        <div class="modal-section">
          <h3 style="margin: 0 0 8px 0; font-size: 1.05em">Shortcuts</h3>
          <ul style="margin-left: 16px">
            <li>Open Help: ⌘/</li>
            <li>Focus Search: ⌘K</li>
            <li>Close Modal: Esc</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" aria-live="polite" aria-busy="true">
      <div class="spinner"></div>
      <div style="margin-top: 8px; font-weight: 600; color: #1d1d1f">Processing...</div>
      <div class="progress" aria-label="Progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>

    <script>
      // Excel processing functions
      function readExcelFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
              resolve(jsonData);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      // Read Modon EOI cell background colors (white/no-fill considered white) using ExcelJS
      function readModonEOIStyles(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async function (e) {
            try {
              const buffer = e.target.result;
              const wb = new ExcelJS.Workbook();
              await wb.xlsx.load(buffer);
              const ws = wb.worksheets[0];
              const headerRow = ws.getRow(3);

              // Find columns by header text
              let unitColIdx = -1;
              let eoiColIdx = -1;
              headerRow.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                const v = cell && cell.value ? String(cell.value).toLowerCase() : "";
                if (v.includes("unit number") && unitColIdx === -1) unitColIdx = colNumber;
                if (v.includes("eoi") && eoiColIdx === -1) eoiColIdx = colNumber;
              });
              if (unitColIdx === -1 || eoiColIdx === -1) return resolve([]);

              const whiteUnits = [];
              const lastRow = ws.actualRowCount || ws.rowCount;
              for (let r = 4; r <= lastRow; r++) {
                const unitCell = ws.getCell(r, unitColIdx);
                const eoiCell = ws.getCell(r, eoiColIdx);
                const unitValRaw = unitCell && unitCell.value;
                if (unitValRaw === null || unitValRaw === undefined || unitValRaw === "") continue;
                const unitId = typeof unitValRaw === "object" && unitValRaw.text ? unitValRaw.text : Array.isArray(unitValRaw?.richText) ? unitValRaw.richText.map((t) => t.text).join("") : String(unitValRaw);

                let isWhite = true; // default to white if no explicit fill
                const fill = eoiCell ? eoiCell.fill : null;
                if (fill && fill.type === "pattern" && fill.pattern === "solid" && fill.fgColor && fill.fgColor.argb) {
                  const argb = String(fill.fgColor.argb).toUpperCase();
                  // Treat as white only when ARGB ends with FFFFFF
                  isWhite = argb.endsWith("FFFFFF");
                }
                if (isWhite) whiteUnits.push(String(unitId).trim());
              }
              resolve(whiteUnits);
            } catch (err) {
              // If style parse fails, resolve empty array to avoid blocking
              resolve([]);
            }
          };
          reader.onerror = () => resolve([]);
          reader.readAsArrayBuffer(file);
        });
      }

      function findColumnIndex(headers, searchTerms) {
        for (let term of searchTerms) {
          for (let i = 0; i < headers.length; i++) {
            if (headers[i] && headers[i].toString().toLowerCase().includes(term.toLowerCase())) {
              return i;
            }
          }
        }
        return -1;
      }

      function compareExcelSheets(modonData, sakneenData, modonWhiteEOIUnits) {
        try {
          // Read Modon sheet (headers at row 3, index 2)
          const modonHeaders = modonData[2];
          const modonUnitCol = findColumnIndex(modonHeaders, ["unit number"]);
          const modonEoiCol = findColumnIndex(modonHeaders, ["eoi"]);
          const modonSalesAgentCol = findColumnIndex(modonHeaders, ["sales agent", "sales_agent"]);
          const modonPriceCol = findColumnIndex(modonHeaders, ["8 yrs egp price"]);

          // Read Sakneen sheet (headers at row 1, index 0)
          const sakneenHeaders = sakneenData[0];
          const sakneenUnitCol = findColumnIndex(sakneenHeaders, ["unitid", "unit id"]);
          const sakneenStatusCol = findColumnIndex(sakneenHeaders, ["status"]);
          const sakneenPriceCol = findColumnIndex(sakneenHeaders, ["price"]);

          if (modonUnitCol === -1 || modonEoiCol === -1 || modonSalesAgentCol === -1 || sakneenUnitCol === -1 || sakneenStatusCol === -1) {
            throw new Error("Required columns not found. Please check your Excel files.");
          }

          // Check if price columns exist (optional)
          const hasPriceComparison = modonPriceCol !== -1 && sakneenPriceCol !== -1;

          // Create mapping from Modon data
          const modonMapping = {};
          for (let i = 3; i < modonData.length; i++) {
            const row = modonData[i];
            if (row[modonUnitCol]) {
              const unitNumber = row[modonUnitCol].toString().trim();
              const eoiValue = row[modonEoiCol];
              const salesAgentValue = row[modonSalesAgentCol];
              const priceValue = hasPriceComparison ? row[modonPriceCol] : null;
              const hasEoi = eoiValue !== null && eoiValue !== undefined && eoiValue.toString().trim() !== "";
              const hasSalesAgent = salesAgentValue !== null && salesAgentValue !== undefined && salesAgentValue.toString().trim() !== "";
              const isAvailable = !hasEoi && !hasSalesAgent;
              modonMapping[unitNumber] = {
                isAvailable: isAvailable,
                price: priceValue,
              };
            }
          }

          // Counters, sets/lists, and discrepancies
          const discrepancies = [];
          const sakneenResult = [...sakneenData];
          const sakneenUnitSet = new Set();
          const sakneenAvailableSet = new Set();
          const sakneenAvailableCommon = [];
          const modonAvailableSet = new Set();
          const modonAvailableCommon = [];

          // Build Modon available list from mapping (EOI empty AND Sales Agent empty) AND EOI cell fill is white
          const whiteSet = new Set(modonWhiteEOIUnits || []);
          for (const [unitId, unitData] of Object.entries(modonMapping)) {
            if (unitData.isAvailable && (whiteSet.size === 0 || whiteSet.has(unitId))) {
              modonAvailableSet.add(unitId);
            }
          }

          for (let i = 1; i < sakneenData.length; i++) {
            const row = sakneenData[i];
            if (row[sakneenUnitCol] && row[sakneenStatusCol]) {
              const unitId = row[sakneenUnitCol].toString().trim();
              const status = row[sakneenStatusCol].toString().trim();
              const sakneenPrice = hasPriceComparison ? row[sakneenPriceCol] : null;
              sakneenUnitSet.add(unitId);

              if (modonMapping.hasOwnProperty(unitId)) {
                const modonData = modonMapping[unitId];
                const isModonAvailable = modonData.isAvailable;
                const isSakneenAvailable = status.toLowerCase() === "available";
                if (isSakneenAvailable) {
                  sakneenAvailableSet.add(unitId);
                  sakneenAvailableCommon.push(unitId);
                }

                // Existing rule: Modon not available (has EOI or Sales Agent) but Sakneen Available
                if (!isModonAvailable && isSakneenAvailable) {
                  discrepancies.push({
                    unit_id: unitId,
                    modon_status: "Not Available (has EOI or Sales Agent)",
                    sakneen_status: status,
                    issue: "EOI or Sales Agent in Modon but Available in Sakneen",
                    type: "status",
                  });
                  if (!sakneenResult[i]._highlight) sakneenResult[i]._highlight = true;
                }

                // New rule: Modon available (EOI empty AND Sales Agent empty) but Sakneen not Available
                if (isModonAvailable && (whiteSet.size === 0 || whiteSet.has(unitId))) {
                  modonAvailableCommon.push(unitId);
                  if (!isSakneenAvailable) {
                    discrepancies.push({
                      unit_id: unitId,
                      modon_status: "Available (no EOI or Sales Agent)",
                      sakneen_status: status,
                      issue: "Available in Modon but not Available in Sakneen",
                      type: "status",
                    });
                    if (!sakneenResult[i]._highlight) sakneenResult[i]._highlight = true;
                  }
                }

                // Price comparison (if both price columns exist)
                if (hasPriceComparison && modonData.price !== null && modonData.price !== undefined && sakneenPrice !== null && sakneenPrice !== undefined) {
                  const modonPrice = parseFloat(modonData.price.toString().replace(/[^\d.-]/g, ""));
                  const sakneenPriceNum = parseFloat(sakneenPrice.toString().replace(/[^\d.-]/g, ""));

                  if (!isNaN(modonPrice) && !isNaN(sakneenPriceNum) && modonPrice !== sakneenPriceNum) {
                    discrepancies.push({
                      unit_id: unitId,
                      modon_price: modonData.price,
                      sakneen_price: sakneenPrice,
                      issue: `Price mismatch: Modon (${modonData.price}) vs Sakneen (${sakneenPrice})`,
                      type: "price",
                    });
                    if (!sakneenResult[i]._highlight) sakneenResult[i]._highlight = true;
                  }
                }
              }
            }
          }

          // Also include Sakneen Available units that are not present in Modon mapping in the All count
          // (keep totals independent). We already added common ones above; add non-common here.
          for (let i = 1; i < sakneenData.length; i++) {
            const row = sakneenData[i];
            if (row[sakneenUnitCol] && row[sakneenStatusCol]) {
              const unitId = row[sakneenUnitCol].toString().trim();
              const status = row[sakneenStatusCol].toString().trim();
              if (!modonMapping.hasOwnProperty(unitId) && status.toLowerCase() === "available") {
                sakneenAvailableSet.add(unitId);
              }
            }
          }

          // Convert sets to sorted arrays
          const modonAvailableAll = Array.from(modonAvailableSet).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" }));
          const sakneenAvailableAll = Array.from(sakneenAvailableSet).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" }));

          // Compute availability differences across ALL units (not just common)
          const availableInModonOnly = modonAvailableAll.filter((u) => !sakneenAvailableSet.has(u));
          const availableInSakneenOnly = sakneenAvailableAll.filter((u) => !modonAvailableSet.has(u));

          // Sort discrepancies by unit id to display alphabetically
          discrepancies.sort((a, b) => String(a.unit_id).localeCompare(String(b.unit_id), undefined, { numeric: true, sensitivity: "base" }));

          return {
            success: true,
            discrepancies: discrepancies,
            total_discrepancies: discrepancies.length,
            sakneenResult: sakneenResult,
            sakneenHeaders: sakneenHeaders,
            modonAvailableCount: modonAvailableAll.length,
            sakneenAvailableCount: sakneenAvailableAll.length,
            modonAvailableIds: modonAvailableAll,
            sakneenAvailableIds: sakneenAvailableAll,
            availableInModonOnly: availableInModonOnly,
            availableInSakneenOnly: availableInSakneenOnly,
            hasPriceComparison: hasPriceComparison,
          };
        } catch (error) {
          return { error: error.message };
        }
      }

      function downloadFile(data, filename, type) {
        const blob = new Blob([data], { type: type });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }

      function exportToCSV(discrepancies) {
        if (discrepancies.length === 0) return;

        const headers = ["Unit ID", "Type", "Modon Value", "Sakneen Value", "Issue"];
        const csvContent = [
          headers.join(","),
          ...discrepancies.map((d) => {
            const modonValue = d.type === "price" ? d.modon_price : d.modon_status;
            const sakneenValue = d.type === "price" ? d.sakneen_price : d.sakneen_status;
            return [`"${d.unit_id}"`, `"${d.type}"`, `"${modonValue}"`, `"${sakneenValue}"`, `"${d.issue}"`].join(",");
          }),
        ].join("\n");

        downloadFile(csvContent, `discrepancies_${new Date().toISOString().slice(0, 19).replace(/[-:]/g, "").replace("T", "_")}.csv`, "text/csv");
      }

      function exportToJSON(discrepancies) {
        const data = {
          timestamp: new Date().toISOString(),
          total_discrepancies: discrepancies.length,
          discrepancies: discrepancies,
        };

        downloadFile(JSON.stringify(data, null, 2), `discrepancies_${new Date().toISOString().slice(0, 19).replace(/[-:]/g, "").replace("T", "_")}.json`, "application/json");
      }

      function exportToExcel(sakneenResult, sakneenHeaders, discrepancies) {
        // Create workbook
        const wb = XLSX.utils.book_new();

        // Add highlighted Sakneen sheet
        const sakneenWS = XLSX.utils.aoa_to_sheet(sakneenResult);
        XLSX.utils.book_append_sheet(wb, sakneenWS, "Sakneen_With_Highlights");

        // Add discrepancies sheet
        const discrepanciesData = [
          ["Unit ID", "Type", "Modon Value", "Sakneen Value", "Issue"],
          ...discrepancies.map((d) => {
            const modonValue = d.type === "price" ? d.modon_price : d.modon_status;
            const sakneenValue = d.type === "price" ? d.sakneen_price : d.sakneen_status;
            return [d.unit_id, d.type, modonValue, sakneenValue, d.issue];
          }),
        ];
        const discrepanciesWS = XLSX.utils.aoa_to_sheet(discrepanciesData);
        XLSX.utils.book_append_sheet(wb, discrepanciesWS, "Discrepancies");

        // Download
        XLSX.writeFile(wb, `sakneen_highlighted_${new Date().toISOString().slice(0, 19).replace(/[-:]/g, "").replace("T", "_")}.xlsx`);
      }

      // Function to check if both files are uploaded and auto-submit
      function checkAndAutoSubmit() {
        const modonFile = document.getElementById("modon_file").files[0];
        const sakneenFile = document.getElementById("sakneen_file").files[0];

        if (modonFile && sakneenFile) {
          // Auto-submit the form
          document.getElementById("uploadForm").dispatchEvent(new Event("submit"));
        }
      }

      // File input change handlers
      document.getElementById("modon_file").addEventListener("change", function (e) {
        if (e.target.files.length > 0) {
          document.getElementById("modonGroup").classList.add("has-file");
        } else {
          document.getElementById("modonGroup").classList.remove("has-file");
        }
        // Check for auto-submit
        checkAndAutoSubmit();
      });

      document.getElementById("sakneen_file").addEventListener("change", function (e) {
        if (e.target.files.length > 0) {
          document.getElementById("sakneenGroup").classList.add("has-file");
        } else {
          document.getElementById("sakneenGroup").classList.remove("has-file");
        }
        // Check for auto-submit
        checkAndAutoSubmit();
      });

      // Toggle tooltip on click for accessibility and mobile
      // Replaced tooltip with a Help modal
      const helpModal = document.getElementById("helpModal");
      const openHelpBtn = document.getElementById("openHelpBtn");
      const closeHelpBtn = document.getElementById("closeHelpBtn");
      function openHelp() {
        helpModal.classList.add("show");
        setTimeout(() => {
          // focus first interactive element for a11y
          closeHelpBtn && closeHelpBtn.focus();
        }, 0);
      }
      function closeHelp() {
        helpModal.classList.remove("show");
      }
      openHelpBtn &&
        openHelpBtn.addEventListener("click", (e) => {
          e.preventDefault();
          openHelp();
        });
      closeHelpBtn && closeHelpBtn.addEventListener("click", closeHelp);
      helpModal &&
        helpModal.addEventListener("click", (e) => {
          if (e.target === helpModal) closeHelp();
        });

      // Form submission handler
      document.getElementById("uploadForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const modonFile = document.getElementById("modon_file").files[0];
        const sakneenFile = document.getElementById("sakneen_file").files[0];

        if (!modonFile || !sakneenFile) {
          alert("Please select both files");
          return;
        }

        // Show loading and compress upload panel
        document.getElementById("loading").style.display = "block";
        const overlay = document.getElementById("loadingOverlay");
        const progressBar = document.getElementById("progressBar");
        if (overlay) overlay.classList.add("show");
        if (progressBar) progressBar.style.width = "10%";
        document.getElementById("results").style.display = "none";
        document.getElementById("compareBtn").disabled = true;
        document.getElementById("uploadPanel").classList.add("compressed");
        document.getElementById("resultsPanel").classList.add("expanded");

        try {
          // Read both files and Modon EOI cell background styles
          const [modonData, sakneenData, modonWhiteEOIUnits] = await Promise.all([
            (async () => {
              const d = await readExcelFile(modonFile);
              if (progressBar) progressBar.style.width = "40%";
              return d;
            })(),
            (async () => {
              const d = await readExcelFile(sakneenFile);
              if (progressBar) progressBar.style.width = "70%";
              return d;
            })(),
            (async () => {
              const d = await readModonEOIStyles(modonFile);
              return d;
            })(),
          ]);

          // Compare the files
          const result = compareExcelSheets(modonData, sakneenData, modonWhiteEOIUnits);
          if (progressBar) progressBar.style.width = "90%";

          // Hide loading and show results
          document.getElementById("loading").style.display = "none";
          document.getElementById("compareBtn").disabled = false;
          if (overlay) overlay.classList.remove("show");
          if (progressBar) progressBar.style.width = "100%";

          // Show results
          const resultsDiv = document.getElementById("results");
          resultsDiv.style.display = "block";

          if (result.error) {
            resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>Error</h3>
                            <p>${result.error}</p>
                        </div>
                    `;
          } else if (result.success) {
            let html = `
              <div class="summary-card">
                <div class="summary-header">
                  <div>
                    <div class="summary-title">Comparison Complete!</div>
                    <div class="summary-subtitle">Found ${result.total_discrepancies} discrepancies</div>
                  </div>
                  <div class="summary-actions">
                    <div class="summary-stat">Modon Available: <strong>${result.modonAvailableCount}</strong></div>
                    <div class="summary-stat">Sakneen Available: <strong>${result.sakneenAvailableCount}</strong></div>
                  </div>
                </div>
              </div>
            `;

            // Tabs for discrepancies and availability lists
            const statusDiscrepancies = result.discrepancies.filter((d) => d.type === "status").length;
            const priceDiscrepancies = result.discrepancies.filter((d) => d.type === "price").length;

            html += `
              <div class="tabs" id="resultsTabs">
                <button class="tab-btn active" data-target="#tab-discrepancies">All Discrepancies (${result.total_discrepancies})</button>
                <button class="tab-btn" data-target="#tab-status-discrepancies">Status Issues (${statusDiscrepancies})</button>
                <button class="tab-btn" data-target="#tab-price-discrepancies">Price Issues (${priceDiscrepancies})</button>
                <button class="tab-btn" data-target="#tab-modon-available">Modon Available (${result.modonAvailableIds.length})</button>
                <button class="tab-btn" data-target="#tab-sakneen-available">Sakneen Available (${result.sakneenAvailableIds.length})</button>
                <button class="tab-btn" data-target="#tab-modon-only">Available in Modon only (${result.availableInModonOnly.length})</button>
                <button class="tab-btn" data-target="#tab-sakneen-only">Available in Sakneen only (${result.availableInSakneenOnly.length})</button>
              </div>

              <div class="tab-panel active" id="tab-discrepancies"></div>
              <div class="tab-panel" id="tab-status-discrepancies"></div>
              <div class="tab-panel" id="tab-price-discrepancies"></div>
              <div class="tab-panel" id="tab-modon-available">
                <div class="id-grid">
                  ${
                    result.modonAvailableIds
                      .map(
                        (id) => `
                    <div class="id-item">
                      <span>${id}</span>
                      <button class="copy-btn" data-unit="${id}" title="Copy">⧉</button>
                    </div>
                  `
                      )
                      .join("") || "None"
                  }
                </div>
              </div>
              <div class="tab-panel" id="tab-sakneen-available">
                <div class="id-grid">
                  ${
                    result.sakneenAvailableIds
                      .map(
                        (id) => `
                    <div class="id-item">
                      <span>${id}</span>
                      <button class="copy-btn" data-unit="${id}" title="Copy">⧉</button>
                    </div>
                  `
                      )
                      .join("") || "None"
                  }
                </div>
              </div>
              <div class="tab-panel" id="tab-modon-only">
                <div class="id-grid">
                  ${
                    result.availableInModonOnly
                      .map(
                        (id) => `
                    <div class="id-item">
                      <span>${id}</span>
                      <button class="copy-btn" data-unit="${id}" title="Copy">⧉</button>
                    </div>
                  `
                      )
                      .join("") || "None"
                  }
                </div>
              </div>
              <div class="tab-panel" id="tab-sakneen-only">
                <div class="id-grid">
                  ${
                    result.availableInSakneenOnly
                      .map(
                        (id) => `
                    <div class="id-item">
                      <span>${id}</span>
                      <button class="copy-btn" data-unit="${id}" title="Copy">⧉</button>
                    </div>
                  `
                      )
                      .join("") || "None"
                  }
                </div>
              </div>
            `;

            // Fill discrepancies tab content
            const buildDiscrepanciesHTML = (discrepancies, title, buttonId) => {
              if (!discrepancies || discrepancies.length === 0) {
                return "<p>No discrepancies found! All units have consistent data.</p>";
              }
              let chunk = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                  <h3 style="margin: 0;">${title}:</h3>
                  <button class="copy-all-btn" id="${buttonId}">
                    <span>📋</span>
                    <span>Copy All Unit IDs</span>
                  </button>
                </div>
              `;
              discrepancies.forEach((discrepancy) => {
                // Helper function to get status class
                const getStatusClass = (status) => {
                  const s = (status || "").toString().toLowerCase();
                  if (s.includes("blocked") || s.includes("not available") || s.includes("unavailable") || s.includes("eoi") || s.includes("sales agent")) {
                    return "status-unavailable";
                  }
                  if (s.includes("available")) return "status-available";
                  return "status-unavailable";
                };

                // Helper function to get status text
                const getStatusText = (status) => {
                  const s = (status || "").toString().toLowerCase();
                  if (s.includes("blocked")) return "Blocked";
                  if (s.includes("not available") || s.includes("unavailable") || s.includes("eoi") || s.includes("sales agent")) return "Unavailable";
                  if (s.includes("available")) return "Available";
                  return "Unavailable";
                };

                if (discrepancy.type === "price") {
                  chunk += `
                    <div class="discrepancy-item">
                      <div>
                        <strong>Unit ${discrepancy.unit_id}</strong>
                        <button class="copy-btn" data-unit="${discrepancy.unit_id}" title="Copy Unit ID">⧉</button>
                        : ${discrepancy.issue}
                      </div>
                      <div class="status-labels">
                        <span class="status-label status-price">Modon: ${discrepancy.modon_price}</span>
                        <span class="status-label status-price">Sakneen: ${discrepancy.sakneen_price}</span>
                      </div>
                    </div>
                  `;
                } else {
                  chunk += `
                    <div class="discrepancy-item">
                      <div>
                        <strong>Unit ${discrepancy.unit_id}</strong>
                        <button class="copy-btn" data-unit="${discrepancy.unit_id}" title="Copy Unit ID">⧉</button>
                        : ${discrepancy.issue}
                      </div>
                      <div class="status-labels">
                        <span class="status-label ${getStatusClass(discrepancy.sakneen_status)}">Sakneen: ${getStatusText(discrepancy.sakneen_status)}</span>
                        <span class="status-label ${getStatusClass(discrepancy.modon_status)}">Modon: ${getStatusText(discrepancy.modon_status)}</span>
                      </div>
                    </div>
                  `;
                }
              });
              return chunk;
            };

            resultsDiv.innerHTML = html;
            document.getElementById("tab-discrepancies").innerHTML = buildDiscrepanciesHTML(result.discrepancies, "All Discrepancies", "copyAllBtn");
            document.getElementById("tab-status-discrepancies").innerHTML = buildDiscrepanciesHTML(
              result.discrepancies.filter((d) => d.type === "status"),
              "Status Discrepancies",
              "copyStatusBtn"
            );
            document.getElementById("tab-price-discrepancies").innerHTML = buildDiscrepanciesHTML(
              result.discrepancies.filter((d) => d.type === "price"),
              "Price Discrepancies",
              "copyPriceBtn"
            );

            // Reveal results toolbar
            const toolbar = document.getElementById("resultsToolbar");
            if (toolbar) toolbar.style.display = "flex";

            // Copy handlers for unit IDs
            Array.from(document.querySelectorAll(".copy-btn")).forEach((btn) => {
              btn.addEventListener("click", async function (ev) {
                console.log("Copy button clicked!");
                const unit = ev.currentTarget.getAttribute("data-unit");
                console.log("Unit to copy:", unit);
                try {
                  await navigator.clipboard.writeText(unit);
                  console.log("Text copied to clipboard");

                  // Remove copied class from all buttons first
                  document.querySelectorAll(".copy-btn").forEach((b) => b.classList.remove("copied"));

                  // Add copied class to this button
                  ev.currentTarget.classList.add("copied");
                  console.log("Added copied class to button");

                  // Add "Copied" text next to the button
                  let statusText = ev.currentTarget.parentNode.querySelector(".copy-status");
                  if (!statusText) {
                    statusText = document.createElement("span");
                    statusText.className = "copy-status";
                    ev.currentTarget.parentNode.appendChild(statusText);
                    console.log("Created status text element");
                  }
                  statusText.textContent = "Copied!";
                  statusText.classList.add("show");
                  console.log("Added copied text");

                  // For discrepancies tab, also add a visual indicator to the discrepancy item
                  const discrepancyItem = ev.currentTarget.closest(".discrepancy-item");
                  if (discrepancyItem) {
                    discrepancyItem.style.borderLeftColor = "#34c759";
                    discrepancyItem.style.boxShadow = "0 4px 20px rgba(52, 199, 89, 0.2)";
                    console.log("Changed discrepancy item color");
                  }

                  // Keep the green state for 5 seconds
                  setTimeout(() => {
                    ev.currentTarget.classList.remove("copied");
                    statusText.classList.remove("show");

                    // Reset discrepancy item styling
                    const discrepancyItem = ev.currentTarget.closest(".discrepancy-item");
                    if (discrepancyItem) {
                      discrepancyItem.style.borderLeftColor = "#ff3b30";
                      discrepancyItem.style.boxShadow = "0 4px 20px rgba(255, 59, 48, 0.1)";
                    }
                    console.log("Reset copy indicators");
                  }, 5000);
                } catch (error) {
                  console.error("Copy failed:", error);
                }
              });
            });

            // Copy all unit IDs button handlers for all tabs
            const setupCopyAllButton = (buttonId, discrepancies) => {
              const copyAllBtn = document.getElementById(buttonId);
              if (copyAllBtn) {
                copyAllBtn.addEventListener("click", async function () {
                  // Extract all unit IDs from discrepancies
                  const unitIds = discrepancies.map((d) => d.unit_id);
                  // Join with newlines to mimic Excel column copy
                  const textToCopy = unitIds.join("\n");

                  try {
                    await navigator.clipboard.writeText(textToCopy);

                    // Visual feedback
                    const originalHTML = copyAllBtn.innerHTML;
                    copyAllBtn.innerHTML = "<span>✓</span><span>Copied!</span>";
                    copyAllBtn.style.background = "linear-gradient(135deg, rgba(52, 199, 89, 0.15) 0%, rgba(48, 209, 88, 0.15) 100%)";
                    copyAllBtn.style.borderColor = "rgba(52, 199, 89, 0.3)";
                    copyAllBtn.style.color = "#34c759";

                    setTimeout(() => {
                      copyAllBtn.innerHTML = originalHTML;
                      copyAllBtn.style.background = "";
                      copyAllBtn.style.borderColor = "";
                      copyAllBtn.style.color = "";
                    }, 2000);
                  } catch (error) {
                    console.error("Failed to copy:", error);
                    alert("Failed to copy unit IDs to clipboard");
                  }
                });
              }
            };

            // Setup copy buttons for all tabs
            setupCopyAllButton("copyAllBtn", result.discrepancies);
            setupCopyAllButton(
              "copyStatusBtn",
              result.discrepancies.filter((d) => d.type === "status")
            );
            setupCopyAllButton(
              "copyPriceBtn",
              result.discrepancies.filter((d) => d.type === "price")
            );

            // Tabs behavior
            Array.from(document.querySelectorAll(".tabs .tab-btn")).forEach((btn) => {
              btn.addEventListener("click", function () {
                document.querySelectorAll(".tabs .tab-btn").forEach((b) => b.classList.remove("active"));
                document.querySelectorAll(".tab-panel").forEach((p) => p.classList.remove("active"));
                this.classList.add("active");
                const target = document.querySelector(this.getAttribute("data-target"));
                if (target) target.classList.add("active");
              });
            });

            // Summary export buttons removed; using toolbar buttons only

            // Top toolbar export buttons
            const exportCsvTop = document.getElementById("exportCsvBtnTop");
            const exportExcelTop = document.getElementById("exportExcelBtnTop");
            const exportJsonTop = document.getElementById("exportJsonBtnTop");
            if (exportCsvTop) exportCsvTop.onclick = () => exportToCSV(result.discrepancies);
            if (exportExcelTop) exportExcelTop.onclick = () => exportToExcel(result.sakneenResult, result.sakneenHeaders, result.discrepancies);
            if (exportJsonTop) exportJsonTop.onclick = () => exportToJSON(result.discrepancies);

            // Search filter for results
            const searchInput = document.getElementById("searchInput");
            if (searchInput) {
              searchInput.addEventListener("input", () => {
                const q = searchInput.value.trim().toLowerCase();
                // Filter discrepancies list only for simplicity
                const container = document.getElementById("tab-discrepancies");
                if (!container) return;
                const items = container.querySelectorAll(".discrepancy-item");
                items.forEach((el) => {
                  const text = el.textContent.toLowerCase();
                  el.style.display = text.includes(q) ? "flex" : "none";
                });
              });
            }
          }
        } catch (error) {
          document.getElementById("loading").style.display = "none";
          document.getElementById("compareBtn").disabled = false;
          const overlay = document.getElementById("loadingOverlay");
          if (overlay) overlay.classList.remove("show");
          document.getElementById("uploadPanel").classList.remove("compressed");
          document.getElementById("resultsPanel").classList.remove("expanded");
          document.getElementById("results").innerHTML = `
                     <div class="error">
                         <h3>Error</h3>
                         <p>Failed to process files: ${error.message}</p>
                     </div>
                 `;
          document.getElementById("results").style.display = "block";
        }
      });

      // Drag & Drop for file inputs
      function enableDnD(inputId, groupId) {
        const group = document.getElementById(groupId);
        if (!group) return;
        ["dragenter", "dragover"].forEach((ev) =>
          group.addEventListener(ev, (e) => {
            e.preventDefault();
            group.classList.add("droppable");
          })
        );
        ["dragleave", "drop"].forEach((ev) =>
          group.addEventListener(ev, (e) => {
            e.preventDefault();
            group.classList.remove("droppable");
          })
        );
        group.addEventListener("drop", (e) => {
          const files = e.dataTransfer?.files;
          if (!files || !files.length) return;
          const input = document.getElementById(inputId);
          if (input) {
            input.files = files;
            input.dispatchEvent(new Event("change", { bubbles: true }));
          }
        });
      }
      enableDnD("modon_file", "modonGroup");
      enableDnD("sakneen_file", "sakneenGroup");

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        const meta = e.metaKey || e.ctrlKey;
        // ⌘/ - open help
        if (meta && e.key === "/") {
          e.preventDefault();
          openHelp();
        }
        // Esc - close help
        if (e.key === "Escape") {
          closeHelp();
        }
        // ⌘k - focus search
        if (meta && e.key.toLowerCase() === "k") {
          const input = document.getElementById("searchInput");
          if (input && input.offsetParent !== null) {
            e.preventDefault();
            input.focus();
          }
        }
      });
    </script>
  </body>
</html>
